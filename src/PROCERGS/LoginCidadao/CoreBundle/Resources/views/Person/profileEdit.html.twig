{% extends "PROCERGSLoginCidadaoCoreBundle::base.loggedIn.html.twig" %}

{% block content %}
<div id="profile-edit" class="content clearfix">

    <h3>{% trans %}Profile{% endtrans %}</h3>

    {% trans_default_domain 'FOSUserBundle' %}

    {{ form_start(form, {'action': path('fos_user_profile_edit'), 'attr': {'role':'form' } }) }}
    {{ form_errors(form) }}

    <div class="form-content">
        <div class="row clearfix">
            <div class="col-md-7">
                <div class="form-group">
                    {{ form_label(form.firstName) }}
                    {{ form_widget(form.firstName, {'attr': {'class': 'form-control'}}) }}
                    <span class="glyphicon glyphicon-remove form-control-feedback"></span>
                    <div class="input-error">{{ form_errors(form.firstName) }}</div>
                </div>
                <div class="form-group">
                    {{ form_label(form.surname) }}
                    {{ form_widget(form.surname, {'attr': {'class': 'form-control'}}) }}
                    <span class="glyphicon glyphicon-remove form-control-feedback"></span>
                    <div class="input-error">{{ form_errors(form.surname) }}</div>
                </div>
                <div class="form-group">
                    {{ form_label(form.email) }}
                    {{ form_widget(form.email, {'attr': {'class': 'form-control'}}) }}
                    <span class="glyphicon glyphicon-remove form-control-feedback"></span>
                    <div class="input-error">{{ form_errors(form.email) }}</div>
                </div>
                <div class="form-inline form-group birthdate">
                    {{ form_label(form.birthdate) }}
                    {{ form_widget(form.birthdate) }}
                    <div class="input-error">{{ form_errors(form.birthdate) }}</div>
                </div>
                <div class="form-group">
                    {{ form_label(form.cep) }}
                    {{ form_widget(form.cep, {'attr': {'class': 'form-control', 'maxlength' : '10'}}) }}
                    <span class="glyphicon glyphicon-remove form-control-feedback"></span>
                    <div class="input-error">{{ form_errors(form.cep) }}</div>
                    <span class="extra">
                        {% trans %}Don't know your CEP?{% endtrans %}
                        <a class="search-cep" href="{{ path('lc_consultaCep') }}">{{ 'Search it!' | trans }}</a>
                    </span>
                </div>
                <div class="form-group">
                    <label for="user_address">{{ 'Your address'|trans }}</label>
                    <span id="user_address"></span>
                </div>
                <div class="form-group">
                    {{ form_label(form.cpf) }}
                    {{ form_widget(form.cpfNfg, {'attr': {'type': 'hidden', 'style' : 'display: none;'}}) }}
                    {% if form.cpf.vars.value is not null %}
	                    {% if form.cpfNfg.vars.value is null or form.cpfNfg.vars.value == '' %}
	                    {{ form_widget(form.cpf, {'attr': {'class': 'form-control', 'maxlength' : '14'}}) }}
	                    <span class="extra">
                            {{ 'cpf.profile.nfg.check.invite' | trans({}, 'messages')  }}
	                        <a class="check-cpf" href="{{ path('lc_registration_cpf') }}">{{ 'cpf.profile.nfg.check.button' | trans({}, 'messages') }}</a>
	                    </span>
	                    {% else %}
	                    {{ form_widget(form.cpf, {'attr': {'type': 'hidden', 'style' : 'display: none;'}}) }}
	                    <span>
	                       {{ form.cpf.vars.value|formatCpf }}
	                    </span><br/>
	                    <span>
	                        {{ 'cpf.registration.nfg.checked.at' | trans({'%date1%' : form.cpfNfg.vars.value}, 'messages')  }}
	                    </span>
	                    {% endif %}
                    {% endif %}
                    <span class="glyphicon glyphicon-remove form-control-feedback"></span>
                    <div class="input-error">{{ form_errors(form.cpf) }}</div>
                </div>
                <div class="form-group">
                    {{ form_label(form.mobile) }}
                    {{ form_widget(form.mobile, {'attr': {'class': 'form-control', 'maxlength' : '14'}}) }}
                    <span class="glyphicon glyphicon-remove form-control-feedback"></span>
                    <div class="input-error">{{ form_errors(form.mobile) }}</div>
                </div>
            </div>

            <div class="col-md-5">
                <div class="row">
                    <div class="col-xs-12">
                        <img src="{% include 'PROCERGSLoginCidadaoCoreBundle:Person:currentUserPicture.html.twig' %}">

                        <div class="file-upload text-center">
                            <button type="button" class="btn btn-success btn-upload">Alterar foto</button>
                            <div class="file-name"></div>
                            {{ form_widget(form.pictureFile) }}
                        </div>
                    </div>
                </div>


                <div class="row">
                    <div class="col-xs-12">
                    {% if app.user.facebookUsername is null %}
                        <div class="connect facebook disabled">
                            <a class="col-xs-11 col-xs-offset-1 username" href="{{ path('lc_link_facebook') }}">{{ 'Connect with Facebook' | trans }}</a>
                        </div>
                    {% else %}
                        <div class="connect facebook">
                            <span class="col-xs-9 col-xs-offset-1 username">{{ app.user.facebookUsername }}</span>
                            {% if app.user.hasPassword %}
                            <a class="col-xs-2 unlink"  href="{{ path('lc_unlink_facebook') }}">
                                <span class="glyphicon glyphicon-remove"></span>
                            </a>
                            {% endif %}
                        </div>
                    {% endif %}

                    {% if app.user.twitterUsername is null %}
                        <div class="connect twitter disabled">
                            <a href="{{ path('hwi_oauth_service_redirect', {'service': 'twitter'}) }}" class="col-xs-11 col-xs-offset-1 username">{{ 'Connect with Twitter' | trans }}</a>
                        </div>
                    {% else %}
                        <div class="connect twitter">
                            <span class="col-xs-9 col-xs-offset-1 username">{{ app.user.twitterUsername }}</span>
                            <a class="col-xs-2 unlink"  href="{{ path('lc_unlink_twitter') }}">
                                <span class="glyphicon glyphicon-remove"></span>
                            </a>
                        </div>
                    {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            {% for type, messages in app.session.flashbag.all() %}
                {% for message in messages %}
                <div class="col-md-12">
                    <div class="text-center bg-success flash-{{ type }}">
                        {{ message }}
                    </div>
                </div>
                {% endfor %}
            {% endfor %}
        </div>


    </div>

    <div class="form-bar text-right">
        <input class="btn btn-success btn-sm" type="submit" value="{{ 'profile.edit.submit'|trans }}" />
    </div>
    {{ form_end(form) }}

</div>

{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
var profileEdit = {};
profileEdit.cepId = '#{{ form.cep.vars.id }}';
profileEdit.cpfId = '#{{ form.cpf.vars.id }}';

profileEdit.popLocation = function (dneData) {
    $(profileEdit.cepId).val(dneData.cep);
    $(profileEdit.cepId).mask('00000-000');
    var street = dneData.tipoLogradouro.capitalize(true, true) + ' ' + dneData.logradouro.capitalize(true, true);
    var city = dneData.localidade.capitalize(true, true);
    var state = dneData.uf;

    $('#user_address').html(street + ',' + city + ', ' + state);
};
$(document).ready(function() {
    $(profileEdit.cepId).mask('00000-000');
    $(profileEdit.cpfId).mask('000.000.000-00');
    $("#{{ form.mobile.vars.id }}").mask("(00) 0000-00009").focusout(function () {
        var phone, element;
        element = $(this); element.unmask();
        phone = element.val().replace(/\D/g, '');
        if (phone.length > 10) {
            element.mask("(00) 90000-0000");
        } else {
            element.mask("(00) 0000-00009");
        }
    });

    $('.search-cep').click(function(event) {
    	event.preventDefault();
        validador.cep.popupConsult(this, event, 'profileEdit.popLocation');
        return false;
    });
    $('.check-cpf').click(function(event) {
    	event.preventDefault()
        var url = $(this).attr('href')+'?cpf='+$(profileEdit.cpfId).val();
        window.open(url, '', "width=600,height=450");
        return false;
    });
    $(profileEdit.cepId).blur(function(event) {
    	validador.cep.findByCep(this, profileEdit.popLocation);
    });
    $(profileEdit.cepId).trigger('blur');
});
</script>
{% endblock %}
